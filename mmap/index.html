<!DOCTYPE html>
<!-- TO DO:
	Retrieve current location and send current location to Ming's datastore - CHECK
	Retrieve/display locations of characters and locations of students in the class
		Last 100 entry, including my own - CHECK
	Distance (in miles) between me and each student needs to be displayed (below the map or as an overlay on the map)

	REQUIREMENTS
	- At least 1 CSS file (named whatever) - CHECK
	- navigator.geolocation object must be used to retrieve my geolocation info - CHECK
	- Display my location on map with a unique marker (image of choice) - CHECK
	- Display info window after retrieving information from navigator.geolocation - CHECK
	- Display locations of students on map (no unique map marker needed) - CHECK
		- Display info window showing (name, latitude, longitude, timestamp) - CHECK
	- Display location of characters w/ respective icon as the marker
		- Display info window showing (name, latitude, longitude, note)
		- Download each character's icon image - CHECK
	- Display polyline(s) between me and each character on map
	- Display distance (in miles) between me and characters
		- SORTED.

-->
<html>
	<head>
		<meta charset="utf-8" />
		<title>I Solemnly Swear...</title>
		<link rel="stylesheet" href="style.css" type="text/css" />
		<script src="http://maps.google.com/maps/api/js?sensor=true"
				type="text/javascript"></script>
		<script>
			var myLat = 0;
			var myLng = 0;
			
			function getLocation() {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(makeMap);
				} else {
					alert("Geolocation is not supported by this browser.");
				}
			}

			function makeMap(position) {
				var currLat = position.coords.latitude;
				var currLng = position.coords.longitude;
				var mapOptions = {
					center: {lat: currLat, lng: currLng},
					zoom: 15
				};
				var map = new google.maps.Map(document.getElementById("map_canvas"),
							mapOptions);

				addMyMarker(map, currLat, currLng);
				sendRequest(map, currLat, currLng);
			}

			function addMyMarker(map, latitude, longitude) {
				var image = "images/pinkiepie.jpeg";
				var marker = new google.maps.Marker({
					position: {lat: latitude, lng: longitude},
					map: map,
					icon: image,
					title: "PinkiePie"
				});
				var windowContent = latitude + ", " + longitude;
				var myWindow = 	new google.maps.InfoWindow({
					content: windowContent
				});
				google.maps.event.addListener(marker, "click", openWindow);
				function openWindow() {
					myWindow.open(map, marker);
				}
			}

			function sendRequest(map, latitude, longitude) {
				var login = "PinkiePie";
				var url = "http://chickenofthesea.herokuapp.com/sendLocation";
				var parameters = "login=" + login + "&lat=" + latitude
								 	+ "&lng=" + longitude;
				var request = new XMLHttpRequest();
				request.open("POST", url, true);
				request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				request.onreadystatechange = getData;
				request.send(parameters);

				function getData() {
					if (request.readyState == 4 && request.status == 200) {
						data = JSON.parse(request.responseText);
						displayStudents(map, data.students);
						displayCharacters(map, data.characters);
					}
				}

				function displayStudents(map, students) {
					for (i = 0; i < students.length; i++) {
						getStudData(map, students[i]);
					}

					function getStudData(map, student) {
						var studLogin = students[i].login;
						var studLat = students[i].lat;
						var studLng = students[i].lng;
						var studTimestamp = students[i].created_at;
						var marker = new google.maps.Marker({
							position: {lat: studLat, lng: studLng}
						});

						marker.setMap(map);
						var studentWindowCont = "<p>" + studLogin + "</p>" 
											+ "<p>" + studLat + ", " + studLng + "</p>"
											+ "<p>" + studTimestamp + "</p>";
						var studentWindow = new google.maps.InfoWindow({
							content: studentWindowCont
						});
						google.maps.event.addListener(marker, "click", openWindow);
						function openWindow() {
							studentWindow.open(map, this);
						}		
					}
				}

				function displayCharacters(map, characters) {
					var charMarkers = {
						"batman": "batman.png",
						"carmen": "carmen.png",
						"hescott": "hescott.png",
						"nr": "nr.png",
						"snape": "snape.png",
						"waldo": "waldo.png"
					};
					for (i = 0; i < characters.length; i++) {
						var character = characters[i];
						getCharData(map, character, charMarkers[character.name]);
					}

					function getCharData(map, character, charMarker) {
						var charName = character.name;
						var charLat = character.loc.latitude;
						var charLng = character.loc.longitude;
						var charNote = character.loc.note;
						var charIcon = charMarker;
						
						var marker = new google.maps.Marker({
							position: {lat: charLat, lng: charLng},
							map: map,
							icon: charIcon
						});

						marker.setMap(map);
						var charWindowCont = "<p>" + charName + "</p>" 
											+ "<p>" + charLat + ", " + charLng + "</p>"
											+ "<p>" + charNote + "</p>";
						var charWindow = new google.maps.InfoWindow({
							content: charWindowCont
						});
						google.maps.event.addListener(marker, "click", openWindow);
						function openWindow() {
							charWindow.open(map, this);
						}	
					}


				}
			}

		</script>

	<body onload="getLocation()">
		<div id="map_canvas"></div>
	</body>


</html>